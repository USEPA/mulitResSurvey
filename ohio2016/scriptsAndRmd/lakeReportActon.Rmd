---
title: "Water Quality and Methane Emissions at Acton Lake"
author: "J. Beaulieu and S. Waldo"
date: "January 26, 2017"
output: 
  pdf_document:
    includes: 
      in_header: header.tex
---
## 1. Background:

The US Environmental Protection Agency (USEPA) is conducting an investigation of methane (CH~4~) dynamics in reservoirs. CH~4~ is a potent greenhouse gas that is produced by microorganisms in reservoir sediments. The objective is to estimate the magnitude of CH~4~ emissions from reservoirs in the United States. 

The USEPA measured CH~4~ emissions from 32 reservoirs in Ohio, Indiana, and Kentucky during the summer of 2016. We designated a minimum of 15 sampling sites in each reservoir (depending on reservoir size), where we measured CH~4~ emissions and several water quality indicators. CH~4~ emissions were measured using a device which captures CH~4~-rich bubbles as they rise through the water column toward the atmosphere. A sonde was used to measure chlorophyll a, dissolved oxygen, pH, specific conductivity, water temperature, and turbidity just below the water surface at each of the 15 sites. Additionally, nutrient chemistry was analyzed at one shallow and one deep site for each reservoir.  

This preliminary report presents results from the USEPA 2016 meausurement campaign relevant to Acton Lake. These data will be included in a formal peer-reviewed publication to be submitted for publication in early 2018.  This preliminary report includes:  

1. This background information
2. A map showing the location of the sampled sites
3. A 3D map of the reservoir showing the measurement results for :
    + CH~4~ emissions
    + Chlorophyll a
4. Figures showing how Acton Lake compared to the other 31 reservoirs in the study in terms of:
    + CH~4~ emissions
    + Total phosphorus 
    + Total nitrogen
    + Chlorophyll a
5. Tables summarizing the other measured water quality values at each site within Acton Lake    
 
Thank you for your help in including Acton Lake in this project. 



```{r setup, results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#myWd <- "C:/Users/JBEAULIE/GitRepository/mulitResSurvey" # for Jake
myWd <- "C:/R_Projects/mulitResSurvey" # for Sarah

globalWd <- "L:/Priv/Cin/NRMRL/ReservoirEbullitionStudy/multiResSurvey2016/grtsDesign/"
```


```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE}
#Get the data and libraries

# knit() creates a new session and therefore can't read objects directly from
# workspace.  Run this file outside of project session and load project
# workspace.

load(paste(myWd, "/.RData", sep = ""))

library(ggplot2)
library(ggmap)
library(dplyr)
library(knitr)
library(rgdal)
```

\newpage

## 2. Map of Sampled Sites    
We sampled Acton Lake on May 31^st^ of 2016. The sampling sites were chosen using a generalized random tesselation stratified design ("GRTS"), an approach which combines elements of systematic and random survey designs which allows for the random allocation of sampling sites with maximum  spatial coverage of the reservoir. We used a GPS and geographic information system (GIS) software to locate each sampling site (+/- 30 meters).  
  
  

```{r results='hide', message=FALSE, warning=FALSE, echo=FALSE, fig.cap='*Location of the fifteen sample sites within Acton Lake. Satellite image from Google Maps.*'}


# Read and project spatial points dataframe for plotting
actonSitesPlot <- readOGR(dsn = paste(globalWd, "acton", sep=""), 
                          layer = "actonSitesEqAreaData")  # shapefile with data

actonSites84 <- spTransform(x = actonSitesPlot, #reproject
                            CRS("+proj=longlat +datum=WGS84")) # projection for google maps

actonSites84@data <- mutate(actonSites84@data, 
                            long=coordinates(actonSites84)[,1], # add long to @data slot
                            lat=coordinates(actonSites84)[,2]) # add lat to @data slot

# Get ggmap
bbox <- make_bbox(data=actonSites84@data, #defines map extent based on sample site lat/lon
                  long, lat, f = 0.4) # f is zoom.  Large #, less zoom. tweak for each lake.  
actonSat <- get_map(location = bbox,
                    color = "color",
                    source = "google",
                    maptype = "satellite")

ggmap(actonSat) +
  ylab("Latitude") +
  xlab ("Longitude") +
  geom_point(data=filter(actonSites84@data, EvalStatus == "sampled"), #only main sites
             aes(x=long, y=lat),
             size = 2, color = "#00BFC4") + # specify color to be consistent across maps
  theme(axis.title.y = element_blank(), # Eliminate x-axis title
        plot.title = element_text(hjust = 0.5)) +  #plot title justify center
  geom_text(data=filter(actonSites84@data, EvalStatus == "sampled"), #only main sites
            aes(label=siteID, x=long, y=lat),
            hjust=1.2, vjust=0, size=2, color = "#00BFC4") +      #alternate color: "#F8766D"
  coord_equal() +
  ggtitle("Acton Lake Sample Sites")
```

 

\newpage


## 3.  Within-lake values of methane emissions and chlorophyll a concentrations  

Previous studies have found a general pattern of higher CH~4~ emissions in the river-reservoir transition (tributary) area, and lower emissions in the deeper downstream waters. Acton Lake did not match this pattern, perhaps because it is a relatively small, shallow water body.  

```{r echo=FALSE, warning=F, message=F, error=F, fig.width=7, fig.height=7, fig.cap='*Methane emissions measured at the 15 sample sites within Acton Lake. The height of each "lollipop" corresponds to the emission rate shown on the vertical z-axis in units of milligrams CH~4~ per square meter of lake surface per hour. The x- and y-axes are oriented east-west and north-south, respectively.*' }


actonEqArea <- readOGR(dsn = paste(globalWd, "acton", sep=""), # get polygon
                           layer = "actonEqArea",  # shapefile name
                            verbose = FALSE)  #keep from reporting progress

actonSitesPlot@data <- merge(actonSitesPlot@data, # add emission to point shp
                             filter(eqAreaData, Lake_Name == "Acton Lake") %>%
                               select(ch4.trate.mg.h, siteID))

# load external script (this is the scatterplot3d function, but changed a bit with to add more user control over style)
source(paste(myWd, "/ohio2016/scriptsAndRmd/scatterplot3d_edit.R", sep = ""))

# grab coordinates from polygon (in order to plot as a line on the xy plane of 3D plot)
coords = fortify(actonEqArea)
coords <- subset(coords, !hole)



##########################################################################
### Total CH4 emission rate
with(actonSitesPlot@data, {
  ch4_plot <- scatterplot3d_edit(x=coords$long, y=coords$lat, z=rep(0,length(coords$long)),   # x y and z data, respectively
                                   color="#282830",                               # color of lake outline
                                   lwd=2.0,                                       # line width of lake outline
                                   type="l",                                      # plot type - "l" = line, "h" = the lollipop style with a line  connecting to the horizontal plane 
                                   angle=40,                                      # angle aspect of plot (-40)
                                   
                                 scale.y=0.5,                                   # scale y axis (increase by 175% (1.75))
                                   #main="Volumetric Gas Emissions at Harsha Lake",      # main plot title
                                   xlab="",                                       # x-axis label (left blank here to reposition later)
                                   ylab="",                                       # y-axis label
                                    cex.axis = 0.7, 
                                 # cex.axis = 1.3,
                                   cex.lab = 1.1,
                                 #cex.lab = 2,
                                   mar = c(5,6,4,2)+0.1,
                                   zlab=expression(CH[4]~emission~rate~(mg~ CH[4]~ m^{-2}~ hr^{-1})),                      # z-axis label
                                   zlim=range(0,15),                            # range of z data shown - I grabbed the max from previously plotting the methane data here. Set so when I add the points, the z-axis fits that data. 
                                   lty.axis=1,                                    # the line type of the axes
                                   axis=TRUE,                                     # wheather to include axes
                                   tick.marks = TRUE,
                                  label.tick.marks = TRUE,   #whether or not to include tick mark labels for all three axes
                                 x.ticklabs=NULL,
                                 y.ticklabs=NULL,
                                 
                                 grid=c('xy','xz','yz'),                        # which grids to show - added to edited version of scatterplot3d fx
                                   lty.grid.xy = 1,                               # grid line type  
                                   lty.grid.xz = 3,
                                   lty.grid.yz = 3,
                                   lwd.grid.xy = 1,                               # line width of grid 
                                   lwd.grid.xz = 1,
                                   lwd.grid.yz = 1,
                                   box=FALSE                                      # get rid of the box around the plot
                                    
                                 )
  

  # add the lollipop points
  ch4_plot$points3d(x=xcoord, y=ycoord, z=as.numeric(as.character(ch4.trate.mg.h)), # x y and z data
                      col="#282830",                      # color of lines connecting points to lake outline
                      lwd=1.5,                            # line width of lines connecting points to lake outline
                      pch=21,                             # type of point to plot
                      bg="#FF0000",                       # fill color of points
                      type="h",                           # plot type = lines to the horizontal plane
                      cex=2 #(vRateBest/500) + 0.5          # scaling of point sizes - this will need to be adjusted for each variable
  )
})
```

\newpage

Similarly, chlorophyll a concentrations in Acton Lake did not show a clear difference between upstream and downstream sites.  

```{r echo=FALSE, warning=F, message=F, error=F, fig.width=7, fig.height=7, fig.cap='*Chlorophyll a concentrations measured at the 15 sample sites within Acton Lake. The height of each "lollipop" corresponds to the concentration shown on the vertical z-axis in units of micrograms per liter of water. The x- and y-axes are oriented east-west and north-south, respectively.*' }
##########################################################################
### chlorophyll plot
with(actonSitesPlot@data, {
  chl_plot <- scatterplot3d_edit(x=coords$long, y=coords$lat, z=rep(0,length(coords$long)),   # x y and z data, respectively
                                   color="#282830",                               # color of lake outline
                                   lwd=2.0,                                       # line width of lake outline
                                   type="l",                                      # plot type - "l" = line, "h" = the lollipop style with a line  connecting to the horizontal plane 
                                   angle=40,                                      # angle aspect of plot (-40)
                                   scale.y=0.5,                                   # scale y axis (increase by 175% (1.75))
                                   #main="Volumetric Gas Emissions at Harsha Lake",      # main plot title
                                   xlab="",                                       # x-axis label (left blank here to reposition later)
                                   ylab="",                                       # y-axis label
                                   cex.axis = 0.7,
                                   cex.lab = 1.1,
                                   mar = c(5,6,4,2)+0.1,
                                   zlab=(expression(chlorophyll~a~paste("(", {mu}, "g ", L^{-1}, ")", sep = ""))),                      # z-axis label
                                   zlim=range(0, 45),                            # range of z data shown - I grabbed the max from previously plotting the methane data here. Set so when I add the points, the z-axis fits that data. 
                                   lty.axis=1,                                    # the line type of the axes
                                   axis=TRUE,                                     # wheather to include axes
                                   grid=c('xy','xz','yz'),                        # which grids to show - added to edited version of scatterplot3d fx
                                   lty.grid.xy = 1,                               # grid line type  
                                   lty.grid.xz = 3,
                                   lty.grid.yz = 3,
                                   lwd.grid.xy = 1,                               # line width of grid 
                                   lwd.grid.xz = 1,
                                   lwd.grid.yz = 1,
                                   box=FALSE                                      # get rid of the box around the plot
  )
  

  # add the lollipop points
  chl_plot$points3d(x=xcoord, y=ycoord, z=as.numeric(as.character(chla_S)), # x y and z data
                      col="#282830",                      # color of lines connecting points to lake outline
                      lwd=1.5,                            # line width of lines connecting points to lake outline
                      pch=21,                             # type of point to plot
                      bg="#FF0000",                       # fill color of points
                      type="h",                           # plot type = lines to the horizontal plane
                      cex=2 #(vRateBest/500) + 0.5          # scaling of point sizes - this will need to be adjusted for each variable
  )
})
```

\newpage

## 4. Comparative plots  

We used the results from the individual measurement sites to calculate mean values and an uncertainty range for the reservoir. The uncertainty measure we used is the 95% confidence interval (CI), which is similar to two standard deviations (sd) from the mean in a normally distributed data set (where 2*sd = 95.45%). In the case of this study, the majority of the uncertainty is due to the spatial variability of a given parameter within the reservoir, rather than uncertainty due to analytical errors. 



```{r echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.cap='*Mean and 95% confidence interval (CI) of the CH~4~ emission rate for each reservoir in this study, calculated from the vaules measured at >=15 sites within each reservoir.*'  }
####################################################################################
### Item #4: Ordered dotplots of total CH4 emissions, DO, TP, TN, and chla

# Highlight Acton Lake (lake of interest) data with color
plotColor <- ifelse(meanVariance.c.lake.lu$Lake_Name == "Acton Lake",
                    "red", "black")

# CH4 total emission rate
# Reset plotting order for CH4 total emissions
# "orderLake" is a function defined in the masterLibrary.R script
meanVariance.c.lake.lu$fLake_Name <- orderLake(meanVariance.c.lake.lu, 
                                               choice1 = "ch4.t")
ggplot(meanVariance.c.lake.lu,
       aes(ch4.trate.mg.h_Estimate, fLake_Name)) +
  geom_point(color = plotColor) +
  geom_errorbarh(aes(xmax = ch4.trate.mg.h_UCB95Pct, 
                     xmin = ch4.trate.mg.h_LCB95Pct), 
                 color = plotColor) +
  xlab(expression(CH[4]~emission~rate~(mg~ CH[4]~ m^{-2}~ hr^{-1}))) +
  theme(axis.title.y = element_blank(), # Eliminate x-axis title
        plot.title = element_text(hjust = 0.5)) +  #plot title justify center
  ggtitle(expression(Mean~CH[4]~emission~rate~
                       paste("(", "95% CI", ")", sep = "")))
```


\newpage

```{r echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.cap='*Mean and 95% confidence interval (CI) of the chlorophyll a concentration for each reservoir in this study, calculated from the vaules measured at >=15 sites within each reservoir.*'  }

# Chlorophyll 
meanVariance.c.lake.lu$fLake_Name <- orderLake(meanVariance.c.lake.lu, 
                                               choice1 = "chl")
ggplot(meanVariance.c.lake.lu,
       aes(chla_Estimate, fLake_Name)) +
  geom_point(color = plotColor) +
  geom_errorbarh(aes(xmax = chla_UCB95Pct, xmin = chla_LCB95Pct), color = plotColor) +
  xlab(expression(chlorophyll~a~paste("(", {mu}, "g ", L^{-1}, ")", sep = ""))) +
  theme(axis.title.y = element_blank(), # Eliminate x-axis title
        plot.title = element_text(hjust = 0.5)) +  #plot title justify center)+
  ggtitle("Mean Chlorophyll a (95% CI)")
```

\newpage

```{r echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.cap='*Mean and 95% confidence interval (CI) of the total phosphorus (TP) concentration for each reservoir in this study, calculated from the vaules measured at >=15 sites within each reservoir.*'  }

# TP 
# Reset plotting order to rank by TP
meanVariance.c.lake.lu$fLake_Name <- orderLake(meanVariance.c.lake.lu, choice1 = "TP")
ggplot(meanVariance.c.lake.lu,
       aes(tp_Estimate, fLake_Name)) +
  geom_point(color = plotColor) +
  geom_errorbarh(aes(xmax = tp_UCB95Pct, 
                     xmin = tp_LCB95Pct), 
                 color = plotColor) +
  xlab(expression(Total~Phosphorus~paste("(", {mu}, "g P ", L^{-1}, ")", sep = ""))) +  
  theme(axis.title.y = element_blank(), # Eliminate x-axis title
        plot.title = element_text(hjust = 0.5)) +  #plot title justify center
  ggtitle("Mean TP (95% CI)")
```

\newpage

```{r echo=FALSE, warning=FALSE, fig.width=7, fig.height=7, fig.cap='*Mean and 95% confidence interval (CI) of the total nitrogen (TN) concentration for each reservoir in this study, calculated from the vaules measured at >=15 sites within each reservoir.*'  }


# TN 
# Reset plotting order to rank by TN
meanVariance.c.lake.lu$fLake_Name <- orderLake(meanVariance.c.lake.lu, choice1 = "TN")
ggplot(meanVariance.c.lake.lu,
       aes(tn_Estimate, fLake_Name)) +
  geom_point(color = plotColor) +
  geom_errorbarh(aes(xmax = tn_UCB95Pct, 
                     xmin = tn_LCB95Pct), 
                 color = plotColor) +
  xlab(expression(Total~Nitrogen~paste("(", {mu}, "g N ", L^{-1}, ")", sep = ""))) +   
  theme(axis.title.y = element_blank(), # Eliminate x-axis title
        plot.title = element_text(hjust = 0.5)) +  #plot title justify center
  ggtitle("Mean TN (95% CI)")




```

\newpage

\blandscape

## 5. Tables of measured values at each site  

Table 1: Surface (0.1 m) water quality parameters measured via sonde at each site

```{r warning=FALSE, echo=FALSE}
######################################################################
#### Item #5: Table of Water Quality Values by Site
## work in progress. Goal: produce a table for each lake with water quality and 
## GHG emissions info, including data that was not in the plots. Need to isolate
## the relevant data for each lake, rename the column headings, and add units

# dplyr package 
#"filter" command filters rows of interest. We're filtering the dataset for the 
# sampled sites at a given lake.
#"select" command selects the columns we want to show. The order they are listed 
#in the () is the order they will appear
#used info from http://j-wang.blogspot.com/2015/03/landscape-and-portrait-in-rmarkdown.html to orient table pages as landscape
actonTableSonde <- filter(eqAreaData, Lake_Name == "Acton Lake", 
                      EvalStatus == "sampled") %>%
                select(siteID, LatSamp, LongSmp,  #site identification  
                chla_S, DO__L_S,  pH_S, SpCn__S, Tmp_C_S,  TrNTU_S) #shallow sonde

kable(actonTableSonde,
      align = "c",
      digits = c(1,5,5,1,1,1,0,1,1),
      col.names = c("Site ID", "Latitude", "Longitude",
                    "Chl a (ug/L)", "DO (mg/L)", "pH",
                    "Sp. Cond", "Water Temp (C)", 
                    "Turbidity"))
```

Table 2: Surface (0.1 m) water chemistry parameters measured at one shallow (U-18) and one deep (U-04) site
```{r warning=FALSE, echo=FALSE} 
actonTableChem <- filter(eqAreaData, Lake_Name == "Acton Lake",
                      EvalStatus == "sampled")  %>%
                  filter(!is.na(TN)) %>%
                  select(siteID, LatSamp, LongSmp,  #site identification, no site depths recorded at Acton  
                          TNH4, TNO2.3, TN, TRP, TP)  #nutrient data 

#tried this first, but couldn't get the inverse ("-") to work
#actonTableChemOrder <- actonTableChem[ order(-actonTableChem$siteID),]                 
actonTableChemOrder <- plyr::arrange(actonTableChem, siteID, decreasing=TRUE)
   
                         
kable(actonTableChemOrder,
      align = "c",
      digits = c(1,5,5,0,0,0,0,0),  #number of digits past decimal
      col.names = c("Site ID", "Latitude", "Longitude",
                    "NH4 (ugN/L)", "NO2.3 (ugN/L)", "Total N (ugN/L)", "Reactive P                       (ug/L)","Total P (ugP/L)" ))                          

```

\elandscape

## 6.  EPA disclaimer

The U.S. Environmental Protection Agency, through its Office of Research and Development, participated in the research described herein. It has been subjected to the Agency's administrative review and has been approved for limited external distribution. Any opinions expressed in this article are those of the authors and do not necessarily reflect the views of the Agency, therefore, no official endorsement should be inferred. Any mention of trade names or commercial products does not constitute endorsement or recommendation for use.
